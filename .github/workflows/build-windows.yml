name: Build Windows Executable

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'  # v로 시작하는 태그 (예: v1.0.0, v2.1.0)
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # 수동 실행 가능
  release:
    types: [created]

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install uv
      uses: astral-sh/setup-uv@v3
      with:
        version: "latest"
    
    - name: Install dependencies
      run: |
        uv sync --dev
    
    - name: Build Windows executable
      run: |
        $OutputEncoding = [console]::InputEncoding = [console]::OutputEncoding = New-Object System.Text.UTF8Encoding
        uv run python build_windows.py
    
    - name: Test executable
      run: |
        .\dist\windows\ascii-painter.exe --help
    
    - name: Upload Windows executable
      uses: actions/upload-artifact@v4
      with:
        name: ascii-painter-windows-x64
        path: dist/windows/
        retention-days: 30
    
    - name: Create release assets (if tag push)
      if: startsWith(github.ref, 'refs/tags/')
      run: |
        # ZIP 파일 생성 (전체 패키지)
        Compress-Archive -Path "dist\windows\*" -DestinationPath "ascii-painter-windows-x64.zip"
        
        # 개별 exe 파일 복사 (직접 다운로드용)
        Copy-Item "dist\windows\ascii-painter.exe" -Destination "ascii-painter.exe"
    
    - name: Create Release (if tag push)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          ascii-painter-windows-x64.zip
          ascii-painter.exe
        name: "ASCII Painter ${{ github.ref_name }}"
        body: |
          ## ASCII Painter ${{ github.ref_name }}
          
          Slack-Optimized ASCII Art Generator - Windows Portable Executable
          
          ### 다운로드
          - `ascii-painter.exe` - 단일 실행 파일 (바로 실행 가능)
          - `ascii-painter-windows-x64.zip` - 전체 패키지 (실행 파일 + README)
          
          ### 사용법
          ```cmd
          # 도움말 보기
          ascii-painter.exe --help
          
          # 기본 사용 (이미지 파일)
          ascii-painter.exe image.jpg 70
          
          # 웹 이미지 사용
          ascii-painter.exe -w https://picsum.photos/400/300 60
          
          # 클립보드에서 입력받고 결과도 클립보드에 복사 (완전 자동화!)
          ascii-painter.exe --clip 80 --trim -a
          ```
          
          ### 빠른 시작
          1. `ascii-painter.exe` 다운로드
          2. 원하는 폴더에 저장
          3. Command Prompt 또는 PowerShell에서 실행
          
          ### 주요 기능
          - 🖼️ 로컬 이미지 파일 지원
          - 🌐 웹 URL에서 이미지 다운로드
          - 📋 클립보드에서 이미지 입력/출력
          - ✂️ 자동 트림으로 컴팩트한 출력
          - 🎨 컬러 모드 지원 (터미널용)
          - 💬 Slack 코드 블록에 최적화
          
          ### 시스템 요구사항
          - Windows 10/11 64비트
          - PowerShell (클립보드 기능용)
          - Python 설치 불필요!
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Upload release assets (manual release)
      if: github.event_name == 'release'
      run: |
        # ZIP 파일 생성 (전체 패키지)
        Compress-Archive -Path "dist\windows\*" -DestinationPath "ascii-painter-windows-x64.zip"
        
        # 개별 exe 파일 복사 (직접 다운로드용)
        Copy-Item "dist\windows\ascii-painter.exe" -Destination "ascii-painter.exe"
    
    - name: Upload to manual release
      if: github.event_name == 'release'
      uses: softprops/action-gh-release@v1
      with:
        files: |
          ascii-painter-windows-x64.zip
          ascii-painter.exe
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
