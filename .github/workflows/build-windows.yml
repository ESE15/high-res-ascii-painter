name: Build Windows Executable

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'  # vë¡œ ì‹œì‘í•˜ëŠ” íƒœê·¸ (ì˜ˆ: v1.0.0, v2.1.0)
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
  release:
    types: [created]

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install uv
      uses: astral-sh/setup-uv@v3
      with:
        version: "latest"
    
    - name: Install dependencies
      run: |
        uv sync --dev
    
    - name: Build Windows executable
      run: |
        $OutputEncoding = [console]::InputEncoding = [console]::OutputEncoding = New-Object System.Text.UTF8Encoding
        uv run python build_windows.py
    
    - name: Test executable
      run: |
        .\dist\windows\ascii-painter.exe --help
    
    - name: Upload Windows executable
      uses: actions/upload-artifact@v4
      with:
        name: ascii-painter-windows-x64
        path: dist/windows/
        retention-days: 30
    
    - name: Create release assets (if tag push)
      if: startsWith(github.ref, 'refs/tags/')
      run: |
        # ZIP íŒŒì¼ ìƒì„± (ì „ì²´ íŒ¨í‚¤ì§€)
        Compress-Archive -Path "dist\windows\*" -DestinationPath "ascii-painter-windows-x64.zip"
        
        # ê°œë³„ exe íŒŒì¼ ë³µì‚¬ (ì§ì ‘ ë‹¤ìš´ë¡œë“œìš©)
        Copy-Item "dist\windows\ascii-painter.exe" -Destination "ascii-painter.exe"
    
    - name: Create Release (if tag push)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          ascii-painter-windows-x64.zip
          ascii-painter.exe
        name: "ASCII Painter ${{ github.ref_name }}"
        body: |
          ## ASCII Painter ${{ github.ref_name }}
          
          Slack-Optimized ASCII Art Generator - Windows Portable Executable
          
          ### ë‹¤ìš´ë¡œë“œ
          - `ascii-painter.exe` - ë‹¨ì¼ ì‹¤í–‰ íŒŒì¼ (ë°”ë¡œ ì‹¤í–‰ ê°€ëŠ¥)
          - `ascii-painter-windows-x64.zip` - ì „ì²´ íŒ¨í‚¤ì§€ (ì‹¤í–‰ íŒŒì¼ + README)
          
          ### ì‚¬ìš©ë²•
          ```cmd
          # ë„ì›€ë§ ë³´ê¸°
          ascii-painter.exe --help
          
          # ê¸°ë³¸ ì‚¬ìš© (ì´ë¯¸ì§€ íŒŒì¼)
          ascii-painter.exe image.jpg 70
          
          # ì›¹ ì´ë¯¸ì§€ ì‚¬ìš©
          ascii-painter.exe -w https://picsum.photos/400/300 60
          
          # í´ë¦½ë³´ë“œì—ì„œ ì…ë ¥ë°›ê³  ê²°ê³¼ë„ í´ë¦½ë³´ë“œì— ë³µì‚¬ (ì™„ì „ ìë™í™”!)
          ascii-painter.exe --clip 80 --trim -a
          ```
          
          ### ë¹ ë¥¸ ì‹œì‘
          1. `ascii-painter.exe` ë‹¤ìš´ë¡œë“œ
          2. ì›í•˜ëŠ” í´ë”ì— ì €ì¥
          3. Command Prompt ë˜ëŠ” PowerShellì—ì„œ ì‹¤í–‰
          
          ### ì£¼ìš” ê¸°ëŠ¥
          - ğŸ–¼ï¸ ë¡œì»¬ ì´ë¯¸ì§€ íŒŒì¼ ì§€ì›
          - ğŸŒ ì›¹ URLì—ì„œ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ
          - ğŸ“‹ í´ë¦½ë³´ë“œì—ì„œ ì´ë¯¸ì§€ ì…ë ¥/ì¶œë ¥
          - âœ‚ï¸ ìë™ íŠ¸ë¦¼ìœ¼ë¡œ ì»´íŒ©íŠ¸í•œ ì¶œë ¥
          - ğŸ¨ ì»¬ëŸ¬ ëª¨ë“œ ì§€ì› (í„°ë¯¸ë„ìš©)
          - ğŸ’¬ Slack ì½”ë“œ ë¸”ë¡ì— ìµœì í™”
          
          ### ì‹œìŠ¤í…œ ìš”êµ¬ì‚¬í•­
          - Windows 10/11 64ë¹„íŠ¸
          - PowerShell (í´ë¦½ë³´ë“œ ê¸°ëŠ¥ìš©)
          - Python ì„¤ì¹˜ ë¶ˆí•„ìš”!
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Upload release assets (manual release)
      if: github.event_name == 'release'
      run: |
        # ZIP íŒŒì¼ ìƒì„± (ì „ì²´ íŒ¨í‚¤ì§€)
        Compress-Archive -Path "dist\windows\*" -DestinationPath "ascii-painter-windows-x64.zip"
        
        # ê°œë³„ exe íŒŒì¼ ë³µì‚¬ (ì§ì ‘ ë‹¤ìš´ë¡œë“œìš©)
        Copy-Item "dist\windows\ascii-painter.exe" -Destination "ascii-painter.exe"
    
    - name: Upload to manual release
      if: github.event_name == 'release'
      uses: softprops/action-gh-release@v1
      with:
        files: |
          ascii-painter-windows-x64.zip
          ascii-painter.exe
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
